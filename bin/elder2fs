#!/usr/bin/env php
<?php

use Monolog\Formatter\LineFormatter;
use Monolog\Handler\StreamHandler;

ini_set('memory_limit', '512M');
set_time_limit(0);

// the bin could be somewhere we don't expect
$paths = [
    __DIR__ . "/../autoload.php",
    __DIR__ . "/../vendor/autoload.php",
    __DIR__ . "/../../vendor/autoload.php",
    __DIR__ . "/../../../vendor/autoload.php",
    __DIR__ . "/../../../../vendor/autoload.php",
];

$included = false;

foreach ($paths as $path) {
    if (file_exists($path)) {
        require_once $path;
        $included = true;
        break;
    }
}

if (!$included) {
    throw new RuntimeException('Autoload failed. Do you need to run composer install?');
}

$log = new Monolog\Logger('elder');
$handler = new StreamHandler('php://stdout', Monolog\Logger::INFO);
$formatter = new LineFormatter("%message%" . PHP_EOL, null, false, true);
$handler->setFormatter($formatter);
$log->pushHandler($handler);

// load the configuration
$config = new \Elder\Config('elder2fs.yml');
$config->load();

// Set up the root directory
$root = new \Elder\Dir();
// ... and build the tree of pages and directories
$root->load($config->getPages());

// Make sure that each directory has a folder on disk
$root->walk('Elder\Dir', function ($dir) use ($log) {
    if (!is_dir($dir->path)) {
        $log->info(sprintf('Creating missing "%s"' . PHP_EOL, $dir->path));
        mkdir($dir->path);
    }
});

$client = new \GuzzleHttp\Client([
    'base_uri' => $config->getService(),
    'timeout' => 5.0,
    'connect_timeout' => 2.0,
]);

// Process Page nodes, writing rendered md documents into "content".
$processor = new \Elder\Processor($client, $config->getVariables(), $log);
$root->walk('Elder\Page', [$processor, 'process']);
